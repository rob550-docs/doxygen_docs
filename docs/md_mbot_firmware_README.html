<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MBot Software Library: mbot-omni-firmware</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MBot Software Library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">mbot-omni-firmware </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Firware to run on the RPi Pico for the MBot Omni.</p>
<h1><a class="anchor" id="autotoc_md6"></a>
Installation</h1>
<p>After cloning the repo, cd into the mbot-omni-firmware directory. Then, run the setup script:</p>
<div class="fragment"><div class="line">./setup.sh</div>
</div><!-- fragment --><p>Which will install dependencies (requires sudo password) and initialize the submodules.</p>
<p>If setup.sh is not executable by default, do the following to enable it:</p>
<div class="fragment"><div class="line">sudo chmod +x setup.sh</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md7"></a>
Possible Issue</h2>
<p>If you come across an error that says that you cannot clone <code>lib/pico-sdk</code>, follow these steps: </p><div class="fragment"><div class="line">cd lib</div>
<div class="line">rm -rf pico-sdk</div>
<div class="line">git clone git clone git@github.com:rob102-staff/pico-sdk.git</div>
<div class="line">cd ..</div>
<div class="line">sudo ./setup.sh</div>
<div class="line">cd lib/pico-sdk</div>
<div class="line">git checkout master</div>
<div class="line">git pull</div>
<div class="line">cd ../../</div>
<div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake ..</div>
<div class="line">make -j4</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md8"></a>
Building</h1>
<p>Build as follows: </p><div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake ..</div>
<div class="line">make</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md9"></a>
Using GDB on the Pico</h1>
<p>As long as the SWD wires are connected to the Raspberry Pi (see above section on main branch), you can use GDB on the Pico to help debug your current firmware or test program.</p>
<p>Note: make sure that the elf file was built using the <code>-DCMAKE_BUILD_TYPE=Debug</code> flag. If the file was built for Release, the optimization means most things won't be visible when you use the print command in gdb later.</p>
<p>Build as normal, then upload using: </p><div class="fragment"><div class="line">upload_swd.sh path/to/elf/file.elf</div>
</div><!-- fragment --><p>In one window, run: </p><div class="fragment"><div class="line">debug.sh path/to/elf/file.elf</div>
</div><!-- fragment --><p>Which starts up the GDB server and blocks this terminal until you Ctrl+C to quit the server. In another terminal, run:</p>
<div class="fragment"><div class="line">debug_attach.sh path/to/elf/file.elf</div>
</div><!-- fragment --><p>Which attaches to the server and stops the program at the start of the main function, from where you can start debugging with GDB commands.</p>
<p>[TODO: get this working in VSCode]</p>
<h1><a class="anchor" id="autotoc_md10"></a>
Installing picotool</h1>
<p>NOTE: this is run in the setup.sh script </p><div class="fragment"><div class="line">export PICO_SDK_PATH=$PWD/lib/pico-sdk</div>
<div class="line">wget https://github.com/raspberrypi/picotool/archive/refs/tags/1.1.1.zip</div>
<div class="line">unzip 1.1.1.zip</div>
<div class="line">cd picotool-1.1.1</div>
<div class="line">mkdir build &amp;&amp; cd build</div>
<div class="line">cmake ..</div>
<div class="line">make</div>
<div class="line">sudo make install</div>
<div class="line">cd ../..</div>
<div class="line">rm 1.1.1.zip</div>
<div class="line">rm -r picotool-1.1.1</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md11"></a>
Installing openocd and gdb-multiarch</h1>
<p>Note: We should add this to the setub.sh script if it is run on a RPi </p><div class="fragment"><div class="line">sudo apt-get install libftdi-dev gdb-multiarch</div>
<div class="line">git clone https://github.com/raspberrypi/openocd.git --recursive --branch rp2040 --depth=1</div>
<div class="line">cd openocd</div>
<div class="line">./bootstrap</div>
<div class="line">./configure --enable-ftdi --enable-sysfsgpio --enable-bcm2835gpio</div>
<div class="line">make -j4</div>
<div class="line">sudo make install</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md12"></a>
Uploading firmware to the pico</h1>
<p>There are a few ways to upload firmware, using the bootload partition on the pico, using picotool or using the upload.sh script and openocd.</p>
<h2><a class="anchor" id="autotoc_md13"></a>
Bootloader</h2>
<p>Plug in the pico while holding the BOOTLOAD button. The pico will be mounted as a drive. Copy the mbot.uf2 file over to the drive.</p>
<h2><a class="anchor" id="autotoc_md14"></a>
picotool</h2>
<p>Plug in the pico while holding the BOOTLOAD button. Run: </p><div class="fragment"><div class="line">picotool load build/src/mbot.uf2</div>
<div class="line">picotool reboot</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md15"></a>
upload_swd.sh and openocd</h2>
<p>[TODO: Check if we can run on pin7 and pin11 instead] Run the upload script which uses openocd. This does not require puting the Pico into bootloader mode. You must have the SWD wires (SWDIO and SWCLK) connected to GPIO 24 (Pin 18), GND (Pin 20) and GPIO 25 (Pin 22) on the Raspberry Pi. Note, when using the upload script and openocd, you upload the .elf firmware file, not the .uf2 firmware file, they are just a different format, but the same firmware. </p><div class="fragment"><div class="line">upload.sh build/src/mbot.elf</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
